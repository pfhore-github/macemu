<!DOCTYPE html>
<html lang="ja">
  <head>
	<meta charset="UTF-8" />
	<title>M68K macintosh hardware reference SCC</title>
	<link rel="stylesheet" href="style.css" />
  </head>
  <body>
	<h1 id="scc">SCC</h1>
	<p>see also <a href="rs422.html">serial port</a>.</p>
	<h2>Pin</h2>
	<dl>
	  <dt>TxD(出力)</dt><dd>出力データ</dd>
	  <dt>RTS(出力)</dt><dd>データ出力の有効化</dd>
	  <dt>RTxC(入力)</dt><dd>VIA1.3が1の時は3.672MHz clock、それ以外はGPiA信号</dd>
	  <dt>CTS(入力)</dt><dt>TRxC(入力)</dt><dd>HSKiA(ハンドシェイク・入力)信号</dd>
	  <dt>DCD(入力)</dt><dd>GPi信号</dd>
	  <dt>DTR(出力)</dt><dd>HSKoA(ハンドシェイク・出力)信号</dd>
	  <dt>REQ(出力：ターゲットはVIA1)</dt><dd>SCC wait/request</dd>
	  <dt>SYNC</dt><dd>Macintoshでは未実装</dd>
	</dl>
	<h2>外部レジスタ</h2>
	<dl>
	  <dt>#00</dt><dd>プリンタポートコマンド</dd>
	  <dt>#02</dt><dd>モデムポートコマンド</dd>
	  <dt>#04</dt><dd>プリンタポートデータ(WR8/RR8と同じ)</dd>
	  <dt>#06</dt><dd>モデムポートデータ(WR8/RR8と同じ)</dd>
	</table>
	<h2>割り込み</h2>
	<p>割り込みではすべてのポートA（モデムポート）割り込みがポートB（プリンタポート）に優先される。</p>
	<p>同じポートでは、以下の順で優先される</p>
	<dl>
	  <dt>1.受信割り込み</dt>
	  <dd>
		<p>すべて、割り込みの起こったデータを読み出すと、割り込みフラグは解除される</p>
		<table>
		  <tr><th>フラグ</th><th>割り込み条件</th><th>補足</th></tr>
		  <tr><th>受信完了</th><td>下記参照</td><td>他の受信割り込みとはベクタの値が違う</td></tr>
		  <tr><th>オーバーラン</th><td>受信FIFOが溢れた</td><td class ="na"></td></tr>
		  <tr><th>フレーミングエラー</th><td>正しくデータが終端していない</td><td><a href="#async">非同期モード</a>のみ</td></tr>
		  <tr><th>フレーム終了</th><td>SDLCのフレームが終端した</td><td><a href="#sdlc">SDLCモード</a>のみ</td></tr>
		  <tr><th>パリティエラー</th><td>パリティビットが一致しない</td><td><a href="#parity">W2.2</a>が有効の場合のみ</td></tr>
		</table>
	  </dd>
	  <dt>2.送信割り込み</dt>
	  <dd><p>WR1.1が有効のときのみ送信割り込みが発生する。これは送信が完了してバッファが空になるたびに割り込みが発生する。CRC計算完了後にも割り込みが発生する。バッファに値を書き込むか、<a href="#reset_tx_int">Reset Tx Int</a>を発行すると、割り込みフラグが解除される</p></dd>
	  <dt>3.特殊割り込み</dt>
	  <dd>
		<p>すべての特殊割り込みはWR1.0が1でなければ無効である。また、WR15の各ビットが0の場合は、対応する割り込みは発生しない。割り込みが発生すると、RR0のうち、WR15が立っているビットはラッチされ、リセットされるまで、割り込み時の値を保持し続ける。</p>
		<table>
		  <tr><th>割り込み</th><th>発生</th><th>解除</th><th>備考</th></tr>
		  <tr><th>ブレーク(非同期モードのみ)</th><td>ブレーク(NULL+framing error)を受信</td><td>ビット1を受信</td><td  rowspan="2">他の割込中でも強制的にラッチされる。</td></tr>
		  <tr><th>アボート(SDLCモードのみ)</th><td>アボート(7つ以上のビット1)を受信</td><td>ビット0を受信</td></tr>
		  <tr><th>転送アンダーラン・転送終了</th><td>送信バッファが空になった時、送信中止コマンドが送信された時</td><td>リセットコマンド送信時</td><td class="na"></td></tr>
		  <tr><th>CTS</th><td>HSKiA信号がHIGHになった時</td><td>HSKiA信号がLOWになった時</td><td class="na"></td></tr>
		  <tr><th>Sync(非同期・外部同期モード)</th><td>SYNC信号がHIGHになった時</td><td>SYNC信号がLOWになった時</td><td><em>macintoshでは未実装</em></td></tr>
		  <tr><th>Hunt(同期モード)</th><td>データ検索開始時（コマンド実行・アボート時）</td><td>データ検索完了時</td><td>フラグ変更時に自動でラッチされる。（解除時も）</td></tr>
		  <tr><th>DTD</th><td>GPi信号がHIGHになった時</td><td>GPi信号がLOWになった時</td><td class="na"></td></tr>
		  <tr><th>ゼロカウント</th><td>ボー・ジェネレータカウンタが0になったとき</td><td>カウンタが初期化された時</td><td class="na"></td></tr>
		</table>
	  </dd>
	</dl>
	<h2>通信プロトコル</h2>
	<h3>データ形式</h3>
	<p>送信時は、ビット数が6以上の場合は、WR8レジスタの下位Nビットが送信される。ビット数が5の場合には、実際のビット数は以下の表で決定される</p>
	<table>
	  <tr><th>データ形式</th><th>ビッド数</th></tr>
	  <tr><th>1111000X</th><td>1</td></tr>
	  <tr><th>111000XX</th><td>2</td></tr>
	  <tr><th>11000XXX</th><td>3</td></tr>
	  <tr><th>1000XXXX</th><td>4</td></tr>
	  <tr><th>000XXXXX</th><td>5</td></tr>
	</table>
	<p>受信時は、非同期モードの場合、非更新ビットは1で埋められ、同期モードの場合は、未定義である。</p>
	<p>以下は各モードで送信されるビット列である。ここで、各データは１〜８ビットのLSBファーストのデータ＋オプションのパリティビットの最大9ビットである</p>
	<dl>
	<dt>非同期モード</dt>
	<dd> [start bit(0)] [data] [ stop bit(1;1/1.5/2 clock) ]</dd>
	<dt>同期モード</dt>
	<dd> [sync char(6/8/12/16 bit) ] [data]* [ CRC ] </dd>
	<dt>SDLCモード</dt>
	<dd> [ begin flag($7E) ] [ address (8bit) ] [ ctl (8bit) ] [data]* [ CRC ] [ end flag( $7E ) ]</dd>
	<h2>内部レジスタ</h2>
	<table><caption>書き込み</caption>
	  <tr>
		<th>番号</th><th>名前</th>
		<th >7(#80)</th><th >6(#40)</th><th >5(#20)</th><th >4(#10)</th>
		<th >3(#08)</th><th >2(#04)</th><th >1(#02)</th><th >0(#01)</th>
	  </tr>
	  <tr><th>0</th><th>コマンドレジスタ</th>
		<td colspan="2">
		  <table><caption>CRC初期化</caption>
			<tr><th>00</th><td>何もしない</td></tr>
			<tr><th>01</th><td>受信CRC</td></tr>
			<tr><th>10</th><td>送信CRC</td></tr>
			<tr><th>11</th><td>メッセージ終了ラッチ</td></tr>
		  </table>
		</td>
		<td colspan="3">
		  <table><caption>汎用コマンド</caption>
			<tr><th>000</th><td>レジスタ番号として0-7を選択する</td></tr>
			<tr><th>001</th><td>レジスタ番号として8-15を選択する</td></tr>
			<tr><th>010</th><td>外部割り込みのラッチを解放する</td></tr>
			<tr><th>011</th><td>SDLCアボートを送信して、メッセージを終了する</td></tr>
			<tr><th>100</th><td id="reset_next_char">先頭文字状態初期化</td></tr>
			<tr><th>101</th><td id="reset_tx_int">送信終了。これ以降、送信バッファが空になっても割り込みを発生させない</td></tr>
			<tr><th>110</th><td>エラーのラッチを解放する</td></tr>
			<tr><th>111</th><td>処理中の割り込み状態を初期化して低位の割り込みを検知できるようにする</td></tr>
		  </table>
		</td>
		<td colspan="3">レジスタ番号</td>
	  </tr>
	  <tr><th>1</th><th>割り込み有効フラグ</th>
		<td>WAIT/DMA要求有効</td>
		<td>
		  <table><caption>W/REQがLowになるタイミング</caption>
			<tr><th>0</th><td>準備完了前にデータを送受信しようとするとき</td></tr>
			<tr><th>1</th><td>準備完了時</td></tr>
		  </table>
		</td>
		<td>
		  <table><caption>W/REQピン送受信フラグ</caption>
			<tr><th>0</th><td>送信バッファの状態</td></tr>
			<tr><th>1</th><td>受信バッファの状態</td></tr>
		  </table>
		</td>
		<td colspan="2">
		  <table><caption>受信割り込みモード</caption>
			<tr><th>00</th><td>無効</td></tr>
			<tr><th>01</th><td>受信完了以外の特殊状態と<a href="#reset_next_char">先頭文字</a>受信</td></tr>
			<tr><th>10</th><td>受信完了以外の特殊状態と文字受信のたびに</td></tr>
			<tr><th>11</th><td>受信完了以外の特殊状態</td></tr>
		  </table>
		</td>
		<td>パリティ異常時にデータエラーにする</td>
		<td>送信割り込み有効</td>
		<td>外部割り込み有効</td>
	  </tr>
	  <tr><th>2</th><th>割り込みベクタ(2ポート共通)</th><td colspan="8">初期割り込みベクタ</td></tr>
	  <tr><th>3</th><th>受信パラメータ</th>
		<td colspan="2">
		  <p>キャラクタあたりの受信ビット数</p>
		  <table>
			<tr><th>00</th><td>5</td></tr>
			<tr><th>01</th><td>7</td></tr>
			<tr><th>10</th><td>6</td></tr>
			<tr><th>11</th><td>8</td></tr>
		  </table>
		</td>
		<td>CTS（送信）/DCD（受信）を受信すると、自動で送受信を開始する</td>
		<td>値1を書き込むと同期モードの探索が開始する</td>
		<td>CRCチェク有効</td>
		<td>SDLCモード有効</td>
		<td>SYNC文字をFIFOへのキューとCRC計算から除外する</td>
		<td>受信有効化</td>
	  </tr>
	  <tr><th>4</th><th>送受信パラメータ</th>
		<td colspan="2">
		  <p>クロック倍率キャラクタあたりの受信ビット数</p>
		  <table>
			<tr><th>00</th><td>1倍</td></tr>
			<tr><th>01</th><td>16倍</td></tr>
			<tr><th>10</th><td>32倍</td></tr>
			<tr><th>11</th><td>64倍</td></tr>
		  </table>
		</td>
		<td colspan="2">
		  <table><caption>SYNCモード</caption>
			<tr><th>00</th><td>8bitSYNC</td></tr>
			<tr><th>01</th><td>16bitSYNC</td></tr>
			<tr><th>10</th><td>SDLCモード</td></tr>
			<tr><th>11</th><td>外部SYNC</td></tr>
		  </table>
		</td>
		<td colspan="2">
		  <table><caption>ASYNCモード</caption>
			<tr><th>00</th><td>ASYNC無効(Syncモード)</td></tr>
			<tr><th>01</th><td>1クロック停止ビット</td></tr>
			<tr><th>10</th><td>1.5クロック停止ビット</td></tr>
			<tr><th>11</th><td>2クロック停止ビット</td></tr>
		  </table>
		</td>
		<td>偶数パリティモード</td>
		<td>パリティ有効</td>	
	  </tr>
	  <tr><th>5</th><th>送信パラメータ</th>
		<td>DTRピン送信</td>
		<td colspan="2">
		  <p>キャラクタあたりの送信ビット数</p>
		  <table>
			<tr><th>00</th><td>5以下</td></tr>
			<tr><th>01</th><td>7</td></tr>
			<tr><th>10</th><td>6</td></tr>
			<tr><th>11</th><td>8</td></tr>
		  </table>
		</td>
		<td>1=強制ブレーク送信</td>
		<td>送信有効化</td>
		<td>CRC-16使用フラグ</td>
		<td>RTSピンビット</td>
		<td>CRC有効フラグ</td>
	  </tr>		
	  <tr><th>6</th><th>Sync文字1/ SDLCアドレス</th>
		<td colspan="8">
		  <table>
			<tr><th>6bit</th><td>送信用8bit Sync（下位6bitが使われる。上位2bitは下位2bitのコピー)</td></tr>
			<tr><th>8bit</th><td>送信用8bit Sync</td></tr>
			<tr><th>12bit</th><td>共用16bit Sync下位(上位4bitのみ、下位4bitは1固定)</td></tr>
			<tr><th>16bit</th><td>共用16bit Sync下位</td></tr>
			<tr><th>SDLC</th><td>アドレスフィールド</td></tr>
		  </table>
		</td>
	  </tr>
	  <tr><th>7</th><th>Sync文字2/ SDLCフラグ</th>
		<td colspan="8">
		  <table>
			<tr><th>6bit</th><td>受信用8bit Sync（<strong>上位</strong>6bitが使われる。)</td></tr>
			<tr><th>8bit</th><td>受信用8bit Sync</td></tr>
			<tr><th>12bit</th><td  rowspan="2">共用16bit Sync上位</td></tr>
			<tr><th>16bit</th></tr>
			<tr><th>SDLC</th><td>01111110固定</td></tr>
		  </table>
		</td>
	  </tr>
	  <tr><th>8</th><th>送信バッファ</th><td colspan="8">送信データ</td></tr>
	  <tr><th>9</th><th>マスター割り込み制御（2ポート共通)</th>
		<td colspan="2">
		  <table>
			<tr><th>00</th><td>何もしない</td></tr>
			<tr><th>01</th><td>プリンタポートリセット</td></tr>
			<tr><th>10</th><td>モデムポートリセット</td></tr>
			<tr><th>11</th><td>SCC全リセット</td></tr>
		  </table>
		</td>
		<td class="na"></td>
		<td>RR2変更位置(1=低位)</td>
		<td>割り込みマスター</td>
		<td>下位割り込み停止</td>
		<td>割り込み応答なし</td>
		<td>割り込み応答にステータスを付加しない</td>
	  </tr>
	  <tr><th>10</th><th>雑多制御</th>
		<td>CRC初期ビット</td>
		<td colspan="2">
		  <table><caption>信号線制御</caption>
			<tr><th>00</th><td>NRZ(HIGH=1,LOW=0)</td></tr>
			<tr><th>01</th><td>NRZI(stay=1,flip=0)</td></tr>
			<tr><th>10</th><td>FM1(edge=1,no-edge=0)</td></tr>
			<tr><th>11</th><td>FM0(no-edge=1, edge=0)</td></tr>
		  </table>
		</td>
		<td>SDLCループモードで$7E送信時にもう1ビット送信する(stub)</td>
		<td>SDLCがアイドル時に1を流す</td>
		<td>SDLCがバッファアンダーランの時にアボート信号を流す</td>
		<td>SDLCループモード</td>
		<td>Syncを6bitにする</td>
	  </tr>
	</table>
  </body>
</html>
