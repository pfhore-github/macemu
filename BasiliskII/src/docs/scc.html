<!DOCTYPE html>
<html lang="ja">
  <head>
	<meta charset="UTF-8" />
	<title>M68K macintosh hardware reference SCC</title>
	<link rel="stylesheet" href="style.css" />
  </head>
  <body>
	<h1 id="scc">SCC</h1>
	<p>see also <a href="rs422.html">serial port</a>.</p>
	<h2>Pin</h2>
	<dl>
	  <dt>TxD(出力)</dt><dd>出力データ</dd>
	  <dt>RTS(出力)</dt><dd>データ出力の有効化</dd>
	  <dt>RTxC(入力)</dt><dd>VIA1.3が1の時は3.672MHz clock、それ以外はGPiA信号</dd>
	  <dt>CTS(入力)</dt><dt>TRxC(入力)</dt><dd>HSKiA(ハンドシェイク・入力)信号</dd>
	  <dt>DCD(入力)</dt><dd>GPi信号</dd>
	  <dt>DTR(出力)</dt><dd>HSKoA(ハンドシェイク・出力)信号</dd>
	  <dt>REQ(出力：ターゲットはVIA1)</dt><dd>SCC wait/request</dd>
	</dl>
	<h2>外部レジスタ</h2>
	<dl>
	  <dt>#00</dt><dd>プリンタポートコマンド</dd>
	  <dt>#02</dt><dd>モデムポートコマンド</dd>
	  <dt>#04</dt><dd>プリンタポートデータ(WR8/RR8と同じ)</dd>
	  <dt>#06</dt><dd>モデムポートデータ(WR8/RR8と同じ)</dd>
	</table>
	<h2>割り込み</h2>
	<p>割り込みではすべてのポートA（モデムポート）割り込みがポートB（プリンタポート）に優先される。</p>
	<p>同じポートでは、以下の順で優先される</p>
	<dl>
	  <dt>1.受信割り込み</dt>
	  <dd>
		<p>すべて、割り込みの起こったデータを読み出すと、割り込みフラグは解除される</p>
		<table>
		  <tr><th>フラグ</th><th>割り込み条件</th><th>補足</th></tr>
		  <tr><th>受信完了</th><td>下記参照</td><td>他の受信割り込みとはベクタの値が違う</td></tr>
		  <tr><th>オーバーラン</th><td>受信FIFOが溢れた</td><td class ="na"></td></tr>
		  <tr><th>フレーミングエラー</th><td>正しくデータが終端していない</td><td><a href="#async">非同期モード</a>のみ</td></tr>
		  <tr><th>フレーム終了</th><td>SDLCのフレームが終端した</td><td><a href="#sdlc">SDLCモード</a>のみ</td></tr>
		  <tr><th>パリティエラー</th><td>パリティビットが一致しない</td><td><a href="#parity">W2.2</a>が有効の場合のみ</td></tr>
		</table>
	  </dd>
	  <dt>2.送信割り込み</dt>
	  <dd><p>WR1.1が有効のときのみ送信割り込みが発生する。これは送信が完了してバッファが空になるたびに割り込みが発生する。CRC計算完了後にも割り込みが発生する。バッファに値を書き込むか、<a href="#reset_tx_int">Reset Tx Int</a>を発行すると、割り込みフラグが解除される</p></dd>
	  <dt>3.特殊割り込み</dt>
	  <dd>
		<p>すべての特殊割り込みはWR1.0が1でなければ無効である。また、WR15の各ビットが0の場合は、対応する割り込みは発生しない。割り込みが発生すると、RR0のうち、WR15が立っているビットはラッチされ、リセットされるまで、割り込み時の値を保持し続ける。</p>
		<table>
		  <tr><th>割り込み</th><th>発生</th><th>解除</th><th>備考</th></tr>
		  <tr><th>ブレーク(非同期モードのみ)</th><td>ブレーク(NULL+framing error)を受信</td><td>ビット1を受信</td><td  rowspan="2">他の割込中でも強制的にラッチされる。</td></tr>
		  <tr><th>アボート(SDLCモードのみ)</th><td>アボート(7つ以上のビット1)を受信</td><td>ビット0を受信</td></tr>
		  <tr><th>転送アンダーラン・転送終了</th><td>送信バッファが空になった時、送信中止コマンドが送信された時</td><td>リセットコマンド送信時</td><td class="na"></td></tr>
		  <tr><th>CTS</th><td>HSKiA信号がHIGHになった時</td><td>HSKiA信号がLOWになった時</td><td class="na"></td></tr>
		  <tr><th>Sync(非同期・外部同期モード)</th><td>SYNC信号がHIGHになった時</td><td>SYNC信号がLOWになった時</td><td><em>macintoshでは未実装</em></td></tr>
		  <tr><th>Hunt(同期モード)</th><td>データ検索開始時（コマンド実行・アボート時）</td><td>データ検索完了時</td><td>フラグ変更時に自動でラッチされる。（解除時も）</td></tr>
		  <tr><th>DTD</th><td>GPi信号がHIGHになった時</td><td>GPi信号がLOWになった時</td><td class="na"></td></tr>
		  <tr><th>ゼロカウント</th><td>ボー・ジェネレータカウンタが0になったとき</td><td>カウンタが初期化された時</td><td class="na"></td></tr>
		</table>
	  </dd>
	</dl>
	<h2>通信プロトコル</h2>
	<h3>データ形式</h3>
	<p>送信時は、ビット数が6以上の場合は、WR8レジスタの下位Nビットが送信される。ビット数が5の場合には、実際のビット数は以下の表で決定される</p>
	<table>
	  <tr><th>データ形式</th><th>ビッド数</th></tr>
	  <tr><th>1111000X</th><td>1</td></tr>
	  <tr><th>111000XX</th><td>2</td></tr>
	  <tr><th>11000XXX</th><td>3</td></tr>
	  <tr><th>1000XXXX</th><td>4</td></tr>
	  <tr><th>000XXXXX</th><td>5</td></tr>
	</table>
	<p>受信時は、非同期モードの場合、非更新ビットは1で埋められ、同期モードの場合は、未定義である。</p>
	<h3>非同期モード</h3>
	<p>非同期モードの信号が開始ビット1、 1-8ビットのデータフィールド(LSB-first)、任意のパリティビット、サイズ1, 1.5, 2クロック分の終了ビット1で表現される。</p>
	<h3>同期モード</h3>
	<p>同期モードの信号は、最初にSYNC文字（6,8,12,16ビット)が送信され、その後に、任意のデータ列(パリティありの場合あり）が続き、最後にCRCデータが送信される。</p>
	<h3>SDLCモード</h3>
	<p>SDLCモードの信号は、最初に$7E文字(~)が送信され、その後に、アドレス(8bit)、制御バイト(8bit)、任意のデータ列(パリティありの場合あり）、CRCデータが続き、再び$7E文字(~)が来て終わる。</p>
	<h2>内部レジスタ</h2>
	<table>
	  <tr>
		<th>番号</th><th>名前</th>
		<th >7(#80)</th><th >6(#40)</th><th >5(#20)</th><th >4(#10)</th>
		<th >3(#08)</th><th >2(#04)</th><th >1(#02)</th><th >0(#01)</th>
	  </tr>
	  <tr><th>0</th><th>コマンドレジスタ</th>
		<td colspan="2">
		  <table><caption>CRC初期化</caption>
			<tr><th>00</th><td>何もしない</td></tr>
			<tr><th>01</th><td>受信CRCの初期化</td></tr>
			<tr><th>10</th><td>送信CRCの初期化</td></tr>
			<tr><th>11</th><td>メッセージ終了を検知できるようにする</td></tr>
		  </table>
		</td>
		<td colspan="3">
		  <table><caption>汎用コマンド</caption>
			<tr><th>000</th><td>レジスタ番号として0-7を選択する</td></tr>
			<tr><th>001</th><td>レジスタ番号として8-15を選択する</td></tr>
			<tr><th>010</th><td>外部割り込みのラッチを解放する</td></tr>
			<tr><th>011</th><td>SDLCアボートを送信して、メッセージを終了する</td></tr>
			<tr><th>100</th><td id="reset_next_char">次に受信した文字を先頭文字として扱う</td></tr>
			<tr><th>101</th><td id="reset_tx_int">送信終了。これ以降、送信バッファが空になっても割り込みを発生させない</td></tr>
			<tr><th>110</th><td>エラーのラッチを解放する</td></tr>
			<tr><th>111</th><td>処理中の割り込み状態を初期化して低位の割り込みを検知できるようにする</td></tr>
		  </table>
		</td>
		<td colspan="3">レジスタ番号</td>
	  </tr>
	  <tr><th>1</th><th>割り込み有効フラグ</th>
		<td>WAIT/DMA要求有効</td>
		<td>
		  <table><caption>W/REQがLowになるタイミング</caption>
			<tr><th>0</th><td>準備完了前にデータを送受信しようとするとき</td></tr>
			<tr><th>1</th><td>準備完了時</td></tr>
		  </table>
		</td>
		<td>
		  <table><caption>W/REQピン送受信フラグ</caption>
			<tr><th>0</th><td>送信バッファの状態</td></tr>
			<tr><th>1</th><td>受信バッファの状態</td></tr>
		  </table>
		</td>
		<td colspan="2">
		  <table><caption>受信割り込みモード</caption>
			<tr><th>00</th><td>無効</td></tr>
			<tr><th>01</th><td>受信完了以外の特殊状態と<a href="#reset_next_char">Enable Interrupt On Next Rx Character Command</a>を発行した直後の文字受信</td></tr>
			<tr><th>10</th><td>受信完了以外の特殊状態と文字受信のたびにRecv interrupt on all chars or special cond</td></tr>
			<tr><th>11</th><td>受信完了以外の特殊状態</td></tr>
		  </table>
		</td>
		<td>パリティ異常時にデータエラーにする</td>
		<td>送信割り込み有効</td>
		<td>外部割り込み有効</td>
	  </tr>
	  <tr><th>2</th><th>割り込みベクタ(2ポート共通)</th><td colspan="8">初期割り込みベクタ</td></tr>
	  <tr><th>3</th><th>受信パラメータ</th>
		<td colspan="2">
		  <p>キャラクタあたりの受信ビット数</p>
		  <table>
			<tr><th>00</th><td>5</td></tr>
			<tr><th>01</th><td>7</td></tr>
			<tr><th>10</th><td>6</td></tr>
			<tr><th>11</th><td>8</td></tr>
		  </table>
		</td>
		<td>CTS（送信）/DCD（受信）を受信すると、自動で送受信を開始する</td>
		<td>値1を書き込むと同期モードの探索が開始する</td>
		<td>CRCチェク有効</td>
		<td>SDLCモード有効</td>
		<td>SYNC文字をFIFOへのキューとCRC計算から除外する</td>
		<td>受信有効化</td>
	  </tr>
	</table>
	<table><caption>Internal(R)</caption>
	  <tr><th rowspan="2">reg</th><th colspan="8">W</th>
	  <tr>
		<th>7(#80)</th><th>6(#40)</th><th>5(#20)</th><th>4(#10)</th><th>3(#08)</th><th>2(#04)</th><th>1(#02)</th><th>0(#01)</th>
	  </tr>
	  <tr><th>0</th>
		<td colspan="2">
		  <table><caption>CRC reset</caption>
			<tr><th>code</th><th>op</th></tr>
			<tr><th>00</th><td>do noting</td></tr>
			<tr><th>01</th><td>reset CRC checker</td></tr>
			<tr><th>10</th><td>reset transmit CRC generator</td></tr>
			<tr><th>11</th><td>reset transmit underrun/EOM latch</td></tr>
		  </table>
		</td>
		<td colspan="3">
		  <table><caption>CRC CMD</caption>
			<tr><th>code</th><th>op</th></tr>
			<tr><th>000</th><td>do noting</td></tr>
			<tr><th>001</th><td>set high register</td></tr>
			<tr><th>010</th><td>reset external/status interrupt</td></tr>
			<tr><th>011</th><td>send abort</td></tr>
			<tr><th>100</th><td>enable interrupt on next character</td></tr>
			<tr><th>101</th><td>reset Transmit interrupt pending</td></tr>
			<tr><th>110</th><td>error reset</td></tr>
			<tr><th>111</th><td>reset highest IUS</td></tr>
		  </table>
		</td>
		<td colspan="3">register number</td>
		<td>break/abort</td>
		<td>Transmit underrun/EOM</td>
		<td>CTS(HSKiA pin)</td>
		<td>sync/hunt</td>
		<td>DCD</td>
		<td>Tranmit buffer empty</td>
		<td>zero count</td>
		<td>recievec character avlaiable</td>
	  </tr>
	  <tr><th>1</th>
		<td>WAIT/DMA Request Enable</td>
		<td>WAIT/DMA Request Function</td>
		<td>WAIT/DMA Request On Recv/Xfer</td>
		<td colspan="2">
		  <table><caption>recv interrupt modes</caption>
			<tr><th>CODE</th><th>meaning</th></tr>
			<tr><th>00</th><td>Recv interrupt disable</td></tr>
			<tr><th>01</th><td>Recv interrupt on first char or special cond</td></tr>
			<tr><th>10</th><td>Recv interrupt on all chars or special cond</td></tr>
			<tr><th>11</th><td>Recv interrupt on special cond</td></tr>
		  </table>
		</td>
		<td>parity is special condtion</td>
		<td>transmitter interrupt enable</td>
		<td>external/status master interrupt enable</td>
		<td>end of frame status(SDLC only)</td>
		<td>CRC(sync/SDLC)/framing error(async) status</td>
		<td>receiver overrun error status</td>
		<td>parity error status</td>
		<td colspan="3">residue codes (SDLC)</td>
		<td>all sent (async)</td>
	</table>
  </body>
</html>
